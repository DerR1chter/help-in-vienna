#!/usr/bin/env python
# pylint: disable=C0116,W0613
# This program is dedicated to the public domain under the CC0 license.

"""
Basic example for a bot that uses inline keyboards. For an in-depth explanation, check out
 https://git.io/JOmFw.
"""
import logging
import time
import sqlite3
import requests
#requests.post('https://api.telegram.org/bot5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY/sendMessage?chat_id=@transport_helo_vienna&text='+)

from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext
from telegram.ext import MessageHandler, Filters

logging.basicConfig(
	format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)

#Writing to DB and sending the message
def open_db():
	try:
		conn = sqlite3.connect('bot_database.db', check_same_thread=False)
		cursor = conn.cursor()
		return cursor, conn

	except sqlite3.Error as error:
		print("Can't connect to DB", error)

def close_db(conn):
	conn.close()

user_info = {"user_id":"", "user_name":"", "status":0, "chosen_button":"", "reply1":"", "reply2":"", "reply3":"", "reply4":""}
def send_message(button):

		def remove_markdown(string):
			return string.replace("_", "\\_").replace("*", "\\*").replace("[", "\\[").replace("`", "\\`")

		if button == 'Button_MaterialAid':
			message = (
			'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info["user_name"]) + ' –Ω–∞ –≤–µ—â–∏ –∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã\n' +
			'- - - - - - - - - - - - - - -\n' +
			'*–°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ:* \n' +
			user_info["reply1"] + '\n' +
			'*–ù–∞ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:* \n' +
			user_info["reply2"] + '\n' +
			'*–ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å:* \n' +
			user_info["reply3"])
			requests.post('https://api.telegram.org/bot5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY/sendMessage?chat_id=@transport_helo_vienna&text='+ message + '&parse_mode=Markdown')
		elif button == 'Button_Transport':
			message = (
			'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info["user_name"]) + ' –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫—É\n' +
			'- - - - - - - - - - - - - - -\n' +
			'*–û—Ç–∫—É–¥–∞:* \n' +
			user_info["reply1"] + '\n' +
			'*–ö—É–¥–∞:* \n' +
			user_info["reply2"] + '\n' +
			'*–ö–æ–≥–¥–∞:* \n' +
			user_info["reply3"]	+'\n' +
			'*–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–µ–∑–¥–∫–µ:* \n' +
			user_info["reply4"])
			requests.post('https://api.telegram.org/bot5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY/sendMessage?chat_id=@transport_helo_vienna&text='+ message + '&parse_mode=Markdown')
		elif button == 'Button_Translation':
			message = (
			'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info["user_name"]) + ' –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ —Å/–Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π\n' +
			'- - - - - - - - - - - - - - -\n' +
			'*–ß—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏:* \n' +
			user_info["reply1"] + '\n' +
			'*–†–£–°-–ù–ï–ú –∏–ª–∏ –ù–ï–ú-–†–£–°:* \n' +
			user_info["reply2"] + '\n' +
			'*–ù–∞ –∫–æ–≥–¥–∞:* \n' +
			user_info["reply3"])
			requests.post('https://api.telegram.org/bot5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY/sendMessage?chat_id=@transport_helo_vienna&text='+ message + '&parse_mode=Markdown')
		elif button == 'Button_Accomponation':
			message = (
			'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info["user_name"]) + ' –Ω–∞ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ\n' +
			'- - - - - - - - - - - - - - -\n' +
			'*–ö—É–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å:* \n' +
			user_info["reply1"] + '\n' +
			'*–ö–æ–≥–¥–∞:* \n' +
			user_info["reply2"] + '\n' +
			'*–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:* \n' +
			user_info["reply3"])		
			requests.post('https://api.telegram.org/bot5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY/sendMessage?chat_id=@transport_helo_vienna&text='+ message + '&parse_mode=Markdown')


def db_table_val(user_id: int, user_name: str, status: int, reply1: str, reply2: str, reply3: str, reply4: str):
	db_conn = open_db()
	cursor = db_conn[0]
	conn = db_conn[1]
	cursor.execute('INSERT INTO our_table (user_id,user_name,status,reply1,reply2,reply3,reply4) VALUES (?, ?, ?, ?, ?, ?, ?)', (user_id,user_name,status,reply1,reply2,reply3,reply4,))
	conn.commit()
	close_db(conn)
	

def before_start(update: Update, context: CallbackContext):
	button = [[KeyboardButton("Press me!")]]
	#keyboard = ReplyKeyboardMarkup(button, one_time_keyboard=True)

	keyboard = [
		[
			InlineKeyboardButton("–í–∑—è—Ç—å –∑–∞—è–≤–∫—É üëç", callback_data='take_request'),
		]
	]

	reply_markup = InlineKeyboardMarkup(keyboard)
	
	context.bot.send_message(chat_id="@transport_helo_vienna", text="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è", reply_markup=reply_markup)
	update.channel_post 
	

def start(update: Update, context: CallbackContext):
	"""Sends a message with three inline buttons attached."""
	keyboard = [
		[
			InlineKeyboardButton("–í–µ—â–∏ –∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã", callback_data='Button_MaterialAid'),
			InlineKeyboardButton("–ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞", callback_data='Button_Transport'),
		],
		[
			InlineKeyboardButton("–ü–µ—Ä–µ–≤–æ–¥ —Å/–Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π", callback_data='Button_Translation'),
			InlineKeyboardButton("–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ", callback_data='Button_Accomponation'),
		],
	]

	reply_markup = InlineKeyboardMarkup(keyboard)

	context.bot.send_message(chat_id=update.effective_chat.id, text="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã –Ω—É–∂–¥–∞–µ—Ç–µ—Å—å.", reply_markup=reply_markup)
	#update.message.reply_text('Please choose:', reply_markup=reply_markup)

def callbackHandler(update: Update, context: CallbackContext) -> None:
	"""Parses the CallbackQuery and updates the message text."""
	query = update.callback_query
	# CallbackQueries need to be answered, even if no notification to the user is needed
	# Some clients may have trouble otherwise. See https://core.telegram.org/bots/api#callbackquery
	query.answer()

	userInput = query.data

	user_info["user_id"] = update.effective_user.id
	user_info["user_name"] = update.effective_user.name

	
	user_info["chosen_button"] = userInput
	if userInput == 'Button_MaterialAid':
		handleButton_MaterialAid(update, context)
	elif userInput == 'Button_Transport':
		handleButton_Transport(update, context)
	elif userInput == 'Button_Translation':
		handleButton_Translation(update, context)
	elif userInput == 'Button_Accomponation':
		handleButton_Accomponation(update, context)

	user_info["status"] = 1


def handleButton_MaterialAid(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤–∞–º –Ω—É–∂–Ω—ã (–µ—Å–ª–∏ –≤–µ—â–µ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ, —Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é): ")

def handleButton_Transport(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –æ—Ç–∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ–∑—Ç–∏: ")

def handleButton_Translation(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏: ")

def handleButton_Accomponation(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å: ")


def handle_message(update: Update, context: CallbackContext) -> None:
	if user_info["chosen_button"] == 'Button_MaterialAid':
		handleResponse_MaterialAid(update, context)
	if user_info["chosen_button"] == 'Button_Transport':
		handleResponse_Transport(update, context)
	if user_info["chosen_button"] == 'Button_Translation':
		handleResponse_Translation(update, context)
	if user_info["chosen_button"] == 'Button_Accomponation':
		handleResponse_Accomponation(update, context)
	
	if user_info["status"] != 0:
		user_info["status"] += 1


def handleResponse_MaterialAid(update: Update, context: CallbackContext) -> None:
	if user_info["status"] == 1:
		user_info["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –Ω–∞ –∫–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–Ω—ã —ç—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç—ã (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ")
	if user_info["status"] == 2:
		user_info["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –∏—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å: ")
	if user_info["status"] == 3:
		user_info["reply3"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram.")
		db_table_val(user_id=user_info["user_id"], user_name=user_info["user_name"], status=user_info["status"], reply1=user_info["reply1"], reply2=user_info["reply2"], reply3=user_info["reply3"], reply4=user_info["reply4"])
		send_message(user_info["chosen_button"])


def handleResponse_Transport(update: Update, context: CallbackContext) -> None:
	if user_info["status"] == 1:
		user_info["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–µ—Ö–∞—Ç—å: ")
	if user_info["status"] == 2:
		user_info["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫–æ–≥–¥–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ—Å—Ç–æ—è—Ç—å—Å—è –ø–æ–µ–∑–¥–∫–∞ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ")
	if user_info["status"] == 3:
		user_info["reply3"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Ü–µ–ª—å –ø–æ–µ–∑–¥–∫–∏ –∏ –≤–∞–∂–Ω—ã–µ –Ω–∞ –≤–∞—à –≤–∑–≥–ª—è–¥ –¥–µ—Ç–∞–ª–∏: ")
	if user_info["status"] == 4:
		user_info["reply4"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram.")
		db_table_val(user_id=user_info["user_id"], user_name=user_info["user_name"], status=user_info["status"], reply1=user_info["reply1"], reply2=user_info["reply2"], reply3=user_info["reply3"], reply4=user_info["reply4"])
		send_message(user_info["chosen_button"])

def handleResponse_Translation(update: Update, context: CallbackContext) -> None:
	if user_info["status"] == 1:
		user_info["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º –ª–∏ –ø–µ—Ä–µ–≤–æ–¥ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –†–£–°-–ù–ï–ú –∏–ª–∏ –ù–ï–ú-–†–£–°): ")
	if user_info["status"] == 2:
		user_info["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –Ω–∞ –∫–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–≤–æ–¥ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ")
	if user_info["status"] == 3:
		user_info["reply3"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram.")
		db_table_val(user_id=user_info["user_id"], user_name=user_info["user_name"], status=user_info["status"], reply1=user_info["reply1"], reply2=user_info["reply2"], reply3=user_info["reply3"], reply4=user_info["reply4"])
		send_message(user_info["chosen_button"])

def handleResponse_Accomponation(update: Update, context: CallbackContext) -> None:
	if user_info["status"] == 1:
		user_info["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫–æ–≥–¥–∞ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ")
	if user_info["status"] == 2:
		user_info["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Ü–µ–ª—å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –∏ –≤–∞–∂–Ω—ã–µ –Ω–∞ –≤–∞—à –≤–∑–≥–ª—è–¥ –¥–µ—Ç–∞–ª–∏: ")
	if user_info["status"] == 3:
		user_info["reply3"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram.")
		db_table_val(user_id=user_info["user_id"], user_name=user_info["user_name"], status=user_info["status"], reply1=user_info["reply1"], reply2=user_info["reply2"], reply3=user_info["reply3"], reply4=user_info["reply4"])
		send_message(user_info["chosen_button"])

'''
def handleResponse_Accomponation(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"Selected option: Material Aid")
'''

def help_command(update: Update, context: CallbackContext) -> None:
	"""Displays info on how to use the bot."""
	update.message.reply_text("Use /start to test this bot.")

def main() -> None:
	"""Run the bot."""
	# Create the Updater and pass it your bot's token.
	updater = Updater("5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY")

	updater.dispatcher.add_handler(CommandHandler('before_start', before_start))
	updater.dispatcher.add_handler(CommandHandler('help', help_command))
	updater.dispatcher.add_handler(CommandHandler('start', start))
	updater.dispatcher.add_handler(CallbackQueryHandler(callbackHandler))
	updater.dispatcher.add_handler(MessageHandler(Filters.text & (~Filters.command), handle_message))


	# Start the Bot
	updater.start_polling()

	# Run the bot until the user presses Ctrl-C or the process receives SIGINT,
	# SIGTERM or SIGABRT
	updater.idle()


if __name__ == '__main__':
	main()
