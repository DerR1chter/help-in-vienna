#!/usr/bin/env python
# pylint: disable=C0116,W0613
# This program is dedicated to the public domain under the CC0 license.

"""
Basic example for a bot that uses inline keyboards. For an in-depth explanation, check out
 https://git.io/JOmFw.
"""
import logging
import time
import sqlite3
import requests
from datetime import date
import re
#requests.post('https://api.telegram.org/bot5134551401:AAGsCzW7j9mTBX8aNC3HRyZX2j68wR4Y5KY/sendMessage?chat_id=@transport_helo_vienna&text='+)

from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton, Contact
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext
from telegram.ext import MessageHandler, Filters

logging.basicConfig(
	format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)

def reset_button():
	keyboard = [
		[
			InlineKeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data='Button_Restart'),
		],
	]
	return InlineKeyboardMarkup(keyboard)

def get_contact():
	keyboard = [
		[
			KeyboardButton("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º", request_contact=True),
		],
	]
	return ReplyKeyboardMarkup(keyboard, resize_keyboard=True,one_time_keyboard=True)

def get_phone_number(update: Update, context: CallbackContext):
	context.bot.send_message(chat_id=update.effective_chat.id, text="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º.", reply_markup=get_contact())


#Writing to DB and sending the message
def open_db():
	try:
		conn = sqlite3.connect('bot_database.db', check_same_thread=False)
		cursor = conn.cursor()
		return cursor, conn

	except sqlite3.Error as error:
		print("Can't connect to DB", error)

def close_db(conn):
	conn.close()

def remove_markdown(string):
		return string.replace("_", "\\_").replace("*", "\\*").replace("[", "\\[").replace("`", "\\`")

def send_message(update: Update, context: CallbackContext, button):
	
	def phone_number(update: Update, context: CallbackContext):
		tel_number = user_info[update.effective_user.id]["phone_number"]
		def check_plus(tel_number):
			if '+' not in tel_number:
				telephone_number = '+' + str(tel_number)
				print(telephone_number)
				return telephone_number
			else:
				return tel_number
		
		if len(tel_number) > 0:
			return ' (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ' + check_plus(tel_number) + ')'

	if button == 'Button_MaterialAid':
		
		message = (
		'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info[update.effective_user.id]["user_name"]) + phone_number(update, context) + ' –Ω–∞ –≤–µ—â–∏ –∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã\n' +
		'- - - - - - - - - - - - - - -\n' +
		'*–°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ:* \n' +
		user_info[update.effective_user.id]["reply1"] + '\n' +
		'*–ù–∞ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:* \n' +
		user_info[update.effective_user.id]["reply2"] + '\n' +
		'*–ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å:* \n' +
		user_info[update.effective_user.id]["reply3"])
		msg = context.bot.send_message(chat_id="@material_aid_in_vienna", text=message, parse_mode="Markdown")
		return msg
	elif button == 'Button_Transport':
		message = (
		'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info[update.effective_user.id]["user_name"]) + phone_number(update, context) + ' –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫—É\n' +
		'- - - - - - - - - - - - - - -\n' +
		'*–û—Ç–∫—É–¥–∞:* \n' +
		user_info[update.effective_user.id]["reply1"] + '\n' +
		'*–ö—É–¥–∞:* \n' +
		user_info[update.effective_user.id]["reply2"] + '\n' +
		'*–ö–æ–≥–¥–∞:* \n' +
		user_info[update.effective_user.id]["reply3"]	+'\n' +
		'*–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–µ–∑–¥–∫–µ:* \n' +
		user_info[update.effective_user.id]["reply4"])
		
		keyboard = [
			[
				InlineKeyboardButton("–í–∑—è—Ç—å –∑–∞—è–≤–∫—É üëç", callback_data='take_request')
			]
		]
		markup = InlineKeyboardMarkup(keyboard)
		msg = context.bot.send_message(chat_id="@transport_in_vienna", text=message, parse_mode="Markdown", reply_markup=markup) 
		return msg
	elif button == 'Button_Translation':
		message = (
		'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info[update.effective_user.id]["user_name"]) + phone_number(update, context) + ' –Ω–∞ —è–∑—ã–∫–æ–≤—É—é –ø–æ–º–æ—â—å\n' +
		'- - - - - - - - - - - - - - -\n' +
		'*–ß—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏:* \n' +
		user_info[update.effective_user.id]["reply1"] + '\n' +
		'*–†–£–°-–ù–ï–ú –∏–ª–∏ –ù–ï–ú-–†–£–°:* \n' +
		user_info[update.effective_user.id]["reply2"] + '\n' +
		'*–ù–∞ –∫–æ–≥–¥–∞:* \n' +
		user_info[update.effective_user.id]["reply3"])
		msg = context.bot.send_message(chat_id="@translations_in_vienna", text=message, parse_mode="Markdown")
		return msg
	elif button == 'Button_Accomponation':
		message = (
		'‚úÖ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + remove_markdown(user_info[update.effective_user.id]["user_name"]) + phone_number(update, context) + ' –Ω–∞ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ\n' +
		'- - - - - - - - - - - - - - -\n' +
		'*–ö—É–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å:* \n' +
		user_info[update.effective_user.id]["reply1"] + '\n' +
		'*–ö–æ–≥–¥–∞:* \n' +
		user_info[update.effective_user.id]["reply2"] + '\n' +
		'*–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:* \n' +
		user_info[update.effective_user.id]["reply3"])		
		msg = context.bot.send_message(chat_id="@accomponation_in_vienna", text=message, parse_mode="Markdown")
		return msg

def update_message(update: Update, context: CallbackContext, button):
	
	if button == 'take_request':
		user_id = update.effective_user.id
		msg_id  = update.callback_query.message.message_id

		db_conn = open_db()
		cursor = db_conn[0]
		conn = db_conn[1]
		cursor.execute('SELECT * FROM users WHERE (user_id, message_id) = (?, ?)', (user_id, msg_id))
		user_created = cursor.fetchall()
		cursor.execute('SELECT * FROM volunteers WHERE (user_id, message_id) = (?, ?)', (user_id, msg_id))
		volunteer_took = cursor.fetchall()
		close_db(conn)
		the_same_user = len(user_created)
		taken_flag = len(volunteer_took) 

		if the_same_user > 0:
			context.bot.send_message(chat_id=user_id, text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É —Å–≤–æ—é –∑–∞—è–≤–∫—É.")
		elif taken_flag > 0:
			keyboard = [
				[
					InlineKeyboardButton("–û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –∑–∞—è–≤–∫–∏ üëé", callback_data='cancel_request')
				]
			]
			markup = InlineKeyboardMarkup(keyboard)
			msg_txt  = update.callback_query.message.text
			user_name = update.effective_user.first_name + " " + update.effective_user.last_name
			word_arr = re.findall("[–ê-—è ]+\:", msg_txt)
			new_arr = []
			for word in word_arr:
				new_word = "*" + word + "*"
				new_arr.append(new_word)
				msg_txt = msg_txt.replace(word, new_word)
			#print(new_arr)
			taken_text = "\n\n*----- –ó–∞—è–≤–∫—É –Ω–æ–º–µ—Ä " + str(msg_id) + " –≤–∑—è–ª(–∞) –≤ —Ä–∞–±–æ—Ç—É " + user_name + " -----*\n\n" + msg_txt
			query = update.callback_query
			query.edit_message_text(text=taken_text, reply_markup=markup, parse_mode="Markdown")
	if button == 'cancel_request':
		keyboard = [
			[
				InlineKeyboardButton("–í–∑—è—Ç—å –∑–∞—è–≤–∫—É üëç", callback_data='take_request')
			]
		]
		markup = InlineKeyboardMarkup(keyboard)
		msg_txt  = update.callback_query.message.text
		user_name = update.effective_user.first_name + " " + update.effective_user.last_name
		word_arr = re.findall("[–ê-—è ]+\:", msg_txt)
		new_arr = []
		for word in word_arr:
			new_word = "*" + word + "*"
			new_arr.append(new_word)
			msg_txt = msg_txt.replace(word, new_word)
		new_txt = msg_txt.split("-----")
		query = update.callback_query
		query.edit_message_text(text=new_txt[2], reply_markup=markup, parse_mode="Markdown")

def db_table_val(user_id: int, user_name: str, phone_number: str, got_contact: bool, role: str, status: int, reply1: str, reply2: str, reply3: str, reply4: str, chosen_button: str, message_id: int):
	db_conn = open_db()
	cursor = db_conn[0]
	conn = db_conn[1]
	cursor.execute('INSERT INTO users (user_id,user_name,phone_number,got_contact,role,status,reply1,reply2,reply3,reply4,chosen_button, message_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)', (user_id, user_name, phone_number, got_contact, role, status, reply1, reply2, reply3, reply4, chosen_button, message_id))
	conn.commit()
	close_db(conn)
	
'''
def before_start(update: Update, context: CallbackContext):
	button = [[KeyboardButton("Press me!")]]
	#keyboard = ReplyKeyboardMarkup(button, one_time_keyboard=True)

	keyboard = [
		[
			InlineKeyboardButton("–í–∑—è—Ç—å –∑–∞—è–≤–∫—É üëç", callback_data='take_request'),
		]
	]

	reply_markup = InlineKeyboardMarkup(keyboard)
	
	msg = context.bot.send_message(chat_id="@transport_helo_vienna", text="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è", reply_markup=reply_markup)
	print(msg.message_id)
	#context.bot.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –æ—Ç–∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ–∑—Ç–∏: ", chat_id="@transport_helo_vienna",message_id=500)
	#context.bot.copyMessage(chat_id="@dead_channel_test", from_chat_id="@transport_helo_vienna", message_id=1)
	'''
		

def start(update: Update, context: CallbackContext):
	"""Sends a message with three inline buttons attached."""
	user_info[update.effective_user.id] = {"user_id":"", "user_name":"", "phone_number":"", "got_contact":False, "role":"", "status":-1, "chosen_button":"", "reply1":"", "reply2":"", "reply3":"", "reply4":"", "category":""}
	

	keyboard = [
		[
			InlineKeyboardButton("üôè –ü–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å", callback_data='Button_NeedHelp'),
			InlineKeyboardButton("ü§ù –û–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å", callback_data='Button_ProvideHelp')
		]
	]

	reply_markup = InlineKeyboardMarkup(keyboard)

	context.bot.send_message(chat_id=update.effective_chat.id, text="–≠—Ç–æ—Ç –±–æ—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ–∫–∞–∑–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏ –ª—é–¥—è–º, –æ–∫–∞–∑–∞–≤—à–∏–º—Å—è –≤ –í–µ–Ω–µ –∏–∑-–∑–∞ –≤–æ–π–Ω—ã –≤ –£–∫—Ä–∞–∏–Ω–µ üá∫üá¶ \n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ, —Ö–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å –∏–ª–∏ –µ–µ –æ–∫–∞–∑–∞—Ç—å:", reply_markup=(reply_markup))

def handleButton_need_help(update: Update, context: CallbackContext):
	keyboard = [
		[
			InlineKeyboardButton("‚õë –í–µ—â–∏ / M–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã", callback_data='Button_MaterialAid'),
			InlineKeyboardButton("üöô –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", callback_data='Button_Transport'),
		],
		[
			InlineKeyboardButton("üí¨ –Ø–∑—ã–∫–æ–≤—ã–µ –ü–µ—Ä–µ–≤–æ–¥—ã", callback_data='Button_Translation'),
			InlineKeyboardButton("üßçüèª –°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ", callback_data='Button_Accomponation'),
		],
		[
			InlineKeyboardButton("üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data='Button_Info', url="https://ukrainians-in-vienna.at/"),
			InlineKeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data='Button_Restart'),
		],
	]

	reply_markup = InlineKeyboardMarkup(keyboard)

	query = update.callback_query
	query.edit_message_text(text="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –ø–æ–º–æ—â–∏, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã –Ω—É–∂–¥–∞–µ—Ç–µ—Å—å:", reply_markup=reply_markup)


def handleButton_provide_help(update: Update, context: CallbackContext):
	message = (
			'–°—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã: \n' +
			'- - - - - - - - - - - - - - -\n' +
			'*–í–µ—â–∏ –∏ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã:* \n' +
			remove_markdown('https://t.me/material_aid_in_vienna') + '\n' +
			'*–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:* \n' +
			remove_markdown('https://t.me/transport_in_vienna') + '\n' +
			'*–Ø–∑—ã–∫–æ–≤–∞—è –ø–æ–º–æ—â—å:* \n' +
			remove_markdown('https://t.me/translations_in_vienna') + '\n' +
			'*–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ:* \n' +
			remove_markdown('https://t.me/accomponation_in_vienna'))
	
	context.bot.send_message(chat_id=update.effective_chat.id, text=message, parse_mode="Markdown", reply_markup=reset_button())


def callbackHandler(update: Update, context: CallbackContext) -> None:
	"""Parses the CallbackQuery and updates the message text."""
	query = update.callback_query
	# CallbackQueries need to be answered, even if no notification to the user is needed
	# Some clients may have trouble otherwise. See https://core.telegram.org/bots/api#callbackquery
	query.answer()

	userInput = query.data

	if userInput == "take_request":
		# first of all, check takes limit
		today = date.today()
		db_conn = open_db()
		cursor = db_conn[0]
		conn = db_conn[1]
		user_id = update.effective_user.id
		cursor.execute('SELECT * FROM volunteers WHERE user_id = (?) AND date_taken = (?)', (user_id, today)) #COUNT(message_id)
		records = cursor.fetchall()
		taken_num = len(records) 
		# if ok, take the request
		if taken_num < 5:
			msg_id  = update.callback_query.message.message_id
			user_name = update.effective_user.name
			cursor.execute('INSERT INTO volunteers (user_id, user_name, message_id, date_taken) VALUES (?, ?, ?, ?)', (user_id, user_name, msg_id, today))
			conn.commit()
			update_message(update, context, userInput)
			return
		else:
			context.bot.send_message(chat_id=user_id, text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ –í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫.")
		close_db(conn)

	if userInput == "cancel_request":
		user_id = update.effective_user.id
		msg_id  = update.callback_query.message.message_id
		db_conn = open_db()
		cursor = db_conn[0]
		conn = db_conn[1]
		cursor.execute('SELECT * FROM volunteers WHERE (user_id, message_id) = (?, ?)', (user_id, msg_id))
		records = cursor.fetchall()
		taken_flag = len(records) 
		if taken_flag > 0:
			cursor.execute('DELETE FROM volunteers WHERE message_id = (?)', (msg_id,))
			conn.commit()
			close_db(conn)
			update_message(update, context, userInput)
		return

	if userInput == "Button_Restart":
		start(update, context)
		return
	
	if ((userInput == "Button_ProvideHelp") and (user_info[update.effective_user.id]["role"] == "Button_NeedHelp")):
		start(update, context)
		return

	if ((userInput == "Button_NeedHelp") and (user_info[update.effective_user.id]["role"] == "Button_ProvideHelp")):
		start(update, context)
		return

	user_info[update.effective_user.id]["user_id"] = update.effective_user.id
	user_info[update.effective_user.id]["user_name"] = update.effective_user.name
	if user_info[update.effective_user.id]["status"] == -1:
		user_info[update.effective_user.id]["role"] = userInput
		if (user_info[update.effective_user.id]["role"] == "Button_ProvideHelp"):
			handleButton_provide_help(update, context)
		elif (user_info[update.effective_user.id]["role"] == "Button_NeedHelp"):
			handleButton_need_help(update, context)
	else:
		user_info[update.effective_user.id]["chosen_button"] = userInput
		if userInput == 'Button_MaterialAid':
			handleButton_MaterialAid(update, context)
		elif userInput == 'Button_Transport':
			handleButton_Transport(update, context)
		elif userInput == 'Button_Translation':
			handleButton_Translation(update, context)
		elif userInput == 'Button_Accomponation':
			handleButton_Accomponation(update, context)

	user_info[update.effective_user.id]["status"] += 1
   

def handleButton_MaterialAid(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤–∞–º –Ω—É–∂–Ω—ã (–µ—Å–ª–∏ –≤–µ—â–µ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ, —Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é): ", reply_markup=reset_button())

def handleButton_Transport(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –æ—Ç–∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ–∑—Ç–∏: ", reply_markup=reset_button())

def handleButton_Translation(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏: ", reply_markup=reset_button())

def handleButton_Accomponation(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å: ", reply_markup=reset_button())

#def handleButton_Take(update: Update, context: CallbackContext) -> None:
#	query = update.callback_query
#	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å: ", reply_markup=reset_button())

#def handleButton_Cancel(update: Update, context: CallbackContext) -> None:
#	query = update.callback_query
#	query.edit_message_text(text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –≤–∞—Å –Ω—É–∂–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å: ", reply_markup=reset_button())

def handle_message(update: Update, context: CallbackContext) -> None:
	if user_info[update.effective_user.id]["chosen_button"] == 'Button_MaterialAid':
		handleResponse_MaterialAid(update, context)
	if user_info[update.effective_user.id]["chosen_button"] == 'Button_Transport':
		handleResponse_Transport(update, context)
	if user_info[update.effective_user.id]["chosen_button"] == 'Button_Translation':
		handleResponse_Translation(update, context)
	if user_info[update.effective_user.id]["chosen_button"] == 'Button_Accomponation':
		handleResponse_Accomponation(update, context)
	
	if user_info[update.effective_user.id]["status"] != 0:
		user_info[update.effective_user.id]["status"] += 1

def handle_contacts(update: Update, context: CallbackContext) -> None:
	user_info[update.effective_user.id]["phone_number"] = update.message.contact.phone_number
	user_info[update.effective_user.id]["got_contact"] = True
	handle_message(update, context)

def handleResponse_MaterialAid(update: Update, context: CallbackContext) -> None:
	if user_info[update.effective_user.id]["status"] == 1:
		user_info[update.effective_user.id]["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –Ω–∞ –∫–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–Ω—ã —ç—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç—ã (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 2:
		user_info[update.effective_user.id]["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –∏—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å: ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 3:
		user_info[update.effective_user.id]["reply3"] = update.message.text
		user_info[update.effective_user.id]["status"] = 4
	if user_info[update.effective_user.id]["status"]>3:
		if not(user_info[update.effective_user.id]["got_contact"]):
			get_phone_number(update, context)
		else:
			msg = send_message(update, context, user_info[update.effective_user.id]["chosen_button"])
			db_table_val(user_id=user_info[update.effective_user.id]["user_id"], user_name=user_info[update.effective_user.id]["user_name"], phone_number=user_info[update.effective_user.id]["phone_number"], got_contact=user_info[update.effective_user.id]["got_contact"], role=user_info[update.effective_user.id]["role"], status=user_info[update.effective_user.id]["status"], reply1=user_info[update.effective_user.id]["reply1"], reply2=user_info[update.effective_user.id]["reply2"], reply3=user_info[update.effective_user.id]["reply3"], reply4=user_info[update.effective_user.id]["reply4"], chosen_button=user_info[update.effective_user.id]["chosen_button"], message_id = msg.message_id )
			context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram. –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å: https://t.me/material_aid_in_vienna/" + str(msg.message_id), reply_markup=reset_button())


def handleResponse_Transport(update: Update, context: CallbackContext) -> None:
	if user_info[update.effective_user.id]["status"] == 1:
		user_info[update.effective_user.id]["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫—É–¥–∞ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–µ—Ö–∞—Ç—å: ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 2:
		user_info[update.effective_user.id]["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫–æ–≥–¥–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ—Å—Ç–æ—è—Ç—å—Å—è –ø–æ–µ–∑–¥–∫–∞ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 3:
		user_info[update.effective_user.id]["reply3"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Ü–µ–ª—å –ø–æ–µ–∑–¥–∫–∏ –∏ –≤–∞–∂–Ω—ã–µ –Ω–∞ –≤–∞—à –≤–∑–≥–ª—è–¥ –¥–µ—Ç–∞–ª–∏: ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 4:
		user_info[update.effective_user.id]["reply4"] = update.message.text
		user_info[update.effective_user.id]["status"] = 5
	if user_info[update.effective_user.id]["status"]>4:
		if not(user_info[update.effective_user.id]["got_contact"]):
			get_phone_number(update, context)
		else:
			msg = send_message(update, context, user_info[update.effective_user.id]["chosen_button"])
			db_table_val(user_id=user_info[update.effective_user.id]["user_id"], user_name=user_info[update.effective_user.id]["user_name"], phone_number=user_info[update.effective_user.id]["phone_number"], got_contact=user_info[update.effective_user.id]["got_contact"], role=user_info[update.effective_user.id]["role"], status=user_info[update.effective_user.id]["status"], reply1=user_info[update.effective_user.id]["reply1"], reply2=user_info[update.effective_user.id]["reply2"], reply3=user_info[update.effective_user.id]["reply3"], reply4=user_info[update.effective_user.id]["reply4"], chosen_button=user_info[update.effective_user.id]["chosen_button"], message_id = msg.message_id )
			context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram. –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å: https://t.me/transport_in_vienna/" + str(msg.message_id), reply_markup=reset_button())


def handleResponse_Translation(update: Update, context: CallbackContext) -> None:
	if user_info[update.effective_user.id]["status"] == 1:
		user_info[update.effective_user.id]["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, —Å –∫–∞–∫–æ–≥–æ —è–∑—ã–∫–∞ –Ω–∞ –∫–∞–∫–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º –ø–µ—Ä–µ–≤–µ–æ–¥ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –£–ö–†-–ù–ï–ú –∏–ª–∏ –ù–ï–ú-–£–ö–†): ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 2:
		user_info[update.effective_user.id]["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –Ω–∞ –∫–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–≤–æ–¥ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 3:
		user_info[update.effective_user.id]["reply3"] = update.message.text
		user_info[update.effective_user.id]["status"] = 4
	if user_info[update.effective_user.id]["status"]>3:
		if not(user_info[update.effective_user.id]["got_contact"]):
			get_phone_number(update, context)
		else:
			msg = send_message(update, context, user_info[update.effective_user.id]["chosen_button"])
			db_table_val(user_id=user_info[update.effective_user.id]["user_id"], user_name=user_info[update.effective_user.id]["user_name"], phone_number=user_info[update.effective_user.id]["phone_number"], got_contact=user_info[update.effective_user.id]["got_contact"], role=user_info[update.effective_user.id]["role"], status=user_info[update.effective_user.id]["status"], reply1=user_info[update.effective_user.id]["reply1"], reply2=user_info[update.effective_user.id]["reply2"], reply3=user_info[update.effective_user.id]["reply3"], reply4=user_info[update.effective_user.id]["reply4"], chosen_button=user_info[update.effective_user.id]["chosen_button"], message_id = msg.message_id )
			context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram. –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å: https://t.me/translations_in_vienna/" + str(msg.message_id), reply_markup=reset_button())


def handleResponse_Accomponation(update: Update, context: CallbackContext) -> None:
	if user_info[update.effective_user.id]["status"] == 1:
		user_info[update.effective_user.id]["reply1"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ù–∞–ø–∏—à–∏—Ç–µ, –∫–æ–≥–¥–∞ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: 01.01.2022, 12:00): ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 2:
		user_info[update.effective_user.id]["reply2"] = update.message.text
		context.bot.send_message(chat_id=update.effective_chat.id, text="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Ü–µ–ª—å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –∏ –≤–∞–∂–Ω—ã–µ –Ω–∞ –≤–∞—à –≤–∑–≥–ª—è–¥ –¥–µ—Ç–∞–ª–∏: ", reply_markup=reset_button())
	if user_info[update.effective_user.id]["status"] == 3:
		user_info[update.effective_user.id]["reply3"] = update.message.text
		user_info[update.effective_user.id]["status"] = 4	
	if user_info[update.effective_user.id]["status"]>3:
		if not(user_info[update.effective_user.id]["got_contact"]):
			get_phone_number(update, context)
		else:
			msg = send_message(update, context, user_info[update.effective_user.id]["chosen_button"])
			db_table_val(user_id=user_info[update.effective_user.id]["user_id"], user_name=user_info[update.effective_user.id]["user_name"], phone_number=user_info[update.effective_user.id]["phone_number"], got_contact=user_info[update.effective_user.id]["got_contact"], role=user_info[update.effective_user.id]["role"], status=user_info[update.effective_user.id]["status"], reply1=user_info[update.effective_user.id]["reply1"], reply2=user_info[update.effective_user.id]["reply2"], reply3=user_info[update.effective_user.id]["reply3"], reply4=user_info[update.effective_user.id]["reply4"], chosen_button=user_info[update.effective_user.id]["chosen_button"], message_id = msg.message_id )
			context.bot.send_message(chat_id=update.effective_chat.id, text="–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–ª–æ–Ω—Ç—ë—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ —á–µ—Ä–µ–∑ Telegram. –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å: https://t.me/accomponation_in_vienna/" + str(msg.message_id), reply_markup=reset_button())


'''
def handleResponse_Accomponation(update: Update, context: CallbackContext) -> None:
	query = update.callback_query
	query.edit_message_text(text=f"Selected option: Material Aid")
'''

def help_command(update: Update, context: CallbackContext) -> None:
	"""Displays info on how to use the bot."""
	update.message.reply_text("Use /start to test this bot.")

def main() -> None:
	"""Run the bot."""
	# Create the Updater and pass it your bot's token.
	updater = Updater("5229228704:AAEAsJ5DZ0Zs_PEw7Y0Ub--sPOoG98Tr8MY")

	global user_info
	user_info = {}
	
	updater.dispatcher.add_handler(CommandHandler('start', start))
	#updater.dispatcher.add_handler(CommandHandler('before_start', before_start))
	updater.dispatcher.add_handler(CommandHandler('help', help_command))
	updater.dispatcher.add_handler(CallbackQueryHandler(callbackHandler))
	updater.dispatcher.add_handler(MessageHandler(Filters.text & (~Filters.command), handle_message))
	updater.dispatcher.add_handler(MessageHandler(Filters.contact, handle_contacts))
    
	# Start the Bot
	updater.start_polling()

	
	# Run the bot until the user presses Ctrl-C or the process receives SIGINT,
	# SIGTERM or SIGABRT
	updater.idle()


if __name__ == '__main__':
	main()